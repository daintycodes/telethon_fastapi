version: "3.9"

services:
  app:
    build: .
    container_name: telethon-fastapi
    environment:
      # Telegram API credentials (required)
      TG_API_ID: "${TG_API_ID}"
      TG_API_HASH: "${TG_API_HASH}"
      TG_SESSION: "${TG_SESSION:-telethon_session}"

      # MinIO/S3 configuration (external service)
      S3_ENDPOINT: "${S3_ENDPOINT}"
      S3_ACCESS_KEY: "${S3_ACCESS_KEY}"
      S3_SECRET_KEY: "${S3_SECRET_KEY}"
      S3_BUCKET_AUDIO: "${S3_BUCKET_AUDIO:-audio}"
      S3_BUCKET_PDF: "${S3_BUCKET_PDF:-pdf}"

      # Database (external service)
      DATABASE_URL: "${DATABASE_URL}"

      # Authentication & security
      ADMIN_API_KEY: "${ADMIN_API_KEY:-}"
      JWT_SECRET: "${JWT_SECRET:-change-this-secret}"

      # Logging & monitoring (optional)
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      SENTRY_DSN: "${SENTRY_DSN:-}"
      SENTRY_TRACES_SAMPLE_RATE: "${SENTRY_TRACES_SAMPLE_RATE:-0.0}"

    volumes:
      # Persist Telethon session files across restarts
      - telethon_session:/app
      # Temporary downloads directory (for files before upload to S3)
      - ./downloads:/app/downloads
      # Persist SQLite DB if used (optional, only if DATABASE_URL is sqlite:///)
      - ./telethon.db:/app/telethon.db

    ports:
      - "8000:8000"

    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

volumes:
  telethon_session:
